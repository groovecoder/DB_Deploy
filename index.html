<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>PEAR:DB::Deploy by groovecoder</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>PEAR:DB::Deploy</h1>
        <h2>Pear::DbDeploy is a pear package to employ dbdeploy as a database change-management tool. (See http://dbdeploy.com/)</h2>
        <a href="https://github.com/groovecoder/DB_Deploy" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h2>
<a name="intro" class="anchor" href="#intro"><span class="octicon octicon-link"></span></a>Intro</h2>

<p>dbdeploy is a Database Change Management tool. It's for developers or DBAs who want to evolve their database design - or refactor their database - in a simple, controlled, flexible and frequent manner. See <a href="http://dbdeploy.com/">dbdeploy.com</a> for more.</p>

<h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Download the DB_Deploy .tgz file from <a href="http://sourceforge.net/project/peardbdeploy">the SourceForge project</a></p>

<p>Install with pear command::
    pear install DB_Deploy-0.9.2.tgz</p>

<h2>
<a name="project-setup" class="anchor" href="#project-setup"><span class="octicon octicon-link"></span></a>Project Setup</h2>

<p>To use dbdeploy, you must follow certain conventions in your project directory (these are not all configurable, yet):</p>

<ol>
<li>Create a table called <code>changelog</code> in the database</li>
<li>Create a directory called <code>dbdeploy</code>
</li>
<li>Within the <code>dbdeploy</code> directory, create a <code>dbdeploy.ini</code> file for configuration</li>
<li>Within the <code>dbdeploy</code> directory, create another directory called <code>deltas</code>
</li>
<li>Within the <code>deltas</code> directory, SQL script files for deployment and rollback of DB changes</li>
</ol><p>Each of these conventions are explained in more detail below. You can also see <a href="http://peardbdeploy.sourceforge.net/example_proj/">a small example project</a>.</p>

<h3>
<a name="changelog-table" class="anchor" href="#changelog-table"><span class="octicon octicon-link"></span></a>changelog table</h3>

<p>dbdeploy relies on the following table in the database in order to track which revisions have deployed to the DB.</p>

<pre><code>CREATE TABLE changelog ( change_number bigint(20) NOT NULL, delta_set varchar(10) NOT NULL, start_dt timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP, complete_dt timestamp NULL default NULL, applied_by varchar(100) NOT NULL, description varchar(500) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>

<p>Note: this SQL is for MySQL, but the same table can be built in any DB. Just ensure the column names are the same, and the types are comparable.</p>

<h3>
<a name="ini" class="anchor" href="#ini"><span class="octicon octicon-link"></span></a>.ini</h3>

<p>.ini config file(s) is/are used to specify settings for DB_Deploy. You can keep multiple .ini files to connect to multiple databases - e.g., dev.ini, test.ini, prod.ini. The structure of the file should be as follows:</p>

<pre><code>[dbdeploy]
    url = sqlite:./db.sqlite
    userid = dbdeploy
    password = dbdeploy
    outputFile = dbdeploy/dbdeploy_deploy.sql
    undoOutputFile = dbdeploy/dbdeploy_undo.sql
    deltaDir = dbdeploy/deltas
</code></pre>

<ul>
<li>
<strong>url</strong> - PDO url for connection to the database</li>
<li>
<strong>username</strong> - username for connection to the database</li>
<li>
<strong>password</strong> - password for connection to the database</li>
<li>
<strong>outputFile</strong> - name of the file which will hold the aggregated SQL for deploying all deltas</li>
<li>
<strong>undoOutputFile</strong> - name of the file which will hold the aggregated SQL for rolling back all deltas</li>
<li>
<strong>deltaDir</strong> - the directory in which all delta files are stored</li>
</ul><p>Note: Only a url value is required; DB_Deploy will use the other values above by default. But you may specify your own values to override these defaults.</p>

<h3>
<a name="delta-scripts" class="anchor" href="#delta-scripts"><span class="octicon octicon-link"></span></a>delta scripts</h3>

<p>Place all delta scripts into the <code>dbdeploy/deltas</code> directory. You should follow the <a href="http://dbdeploy.com/documentation/getting-started/rules-for-using-dbdeploy/">rules for dbdeploy usage</a></p>

<ul>
<li>Make sure that EVERY database modification is written as a delta script to be picked up by dbdeploy.</li>
<li>Follow the naming convention for delta scripts. Script names must begin with a number that indicates the order in which it should be run (1.sql gets run first, then 2.sql and so on). You can optionally add a comment to the file name to describe what the script does (eg 1 Created the CustomerAddress table.sql) the comment will get written to the schema version table as the script is applied.</li>
<li>You can optionally add an undo section to your script. Write the script so it performs the do action first (eg create the CustomerAddress table) once all do actions have been scripted include the token <code>--//@UNDO</code>` on a new line. Include the undo steps after this token.</li>
<li>If you realise that you've made a mistake in a delta script that's been checked in then consider carefully how to fix it.</li>
</ul><h2>
<a name="using-dbdeploy" class="anchor" href="#using-dbdeploy"><span class="octicon octicon-link"></span></a>Using dbdeploy</h2>

<p>Assumming you have followed the instructions and rules as above, you can now roll up your DB changes by simply using the <code>dbdeploy</code> command from within your project directory.</p>

<pre><code>$ dbdeploy -c dbdeploy/example_proj_prod.ini
setting configFile to: dbdeploy/example_proj_prod.ini
Getting applied changed numbers from DB at: sqlite:./prod.sqlite
Current db revision: 0
Creating deploy SQL file, dbdeploy/dbdeploy_deploy.sql
        adding deploy SQL from 001_create_test_table.sql ... done.
        adding deploy SQL from 002_add_test_record.sql ... done.
Creating undo SQL file, dbdeploy/dbdeploy_undo.sql
        adding undo SQL from 002_add_test_record.sql ... done.
        adding undo SQL from 001_create_test_table.sql ... done.
</code></pre>

<p>It will aggregate the SQL from the necessary delta script files, and create the output files as specified in the config file.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/groovecoder/DB_Deploy/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/groovecoder/DB_Deploy/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/groovecoder/DB_Deploy"></a> is maintained by <a href="https://github.com/groovecoder">groovecoder</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>